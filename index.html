<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Page Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* Shimmer effect for loading */
        .shimmer {
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 800px 104px;
            animation: shimmer 1.2s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }
            100% {
                background-position: 468px 0;
            }
        }
        
        #confirmation-modal, #menu-modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Hamburger Menu Button -->
    <button id="menu-btn" class="absolute top-4 left-4 z-50 p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-200">
        <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
    </button>

    <!-- Side Menu Modal -->
    <div id="menu-modal" class="fixed inset-0 z-40 bg-gray-900 bg-opacity-50 hidden">
        <div class="fixed top-0 left-0 h-full w-64 bg-white rounded-r-lg shadow-xl p-6 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Menu</h2>
                <button id="your-links-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200">
                    Your Created HTML Links
                </button>
                <button id="account-management-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200">
                    Account Management
                </button>
                <div id="account-options" class="pl-4 hidden flex flex-col space-y-2 pt-2 border-t mt-2">
                    <button id="delete-account-btn" class="text-left text-red-500 hover:text-red-700 transition-colors duration-200">
                        Delete Account
                    </button>
                </div>
            </div>
            <button id="close-menu-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="app-container" class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl transition-all duration-300">
        <!-- Main Form View -->
        <div id="main-view" class="flex flex-col space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">Generate Your HTML Page</h1>
            <p class="text-center text-gray-600">Enter your HTML code below and get a shareable link.</p>
            <textarea id="html-input" rows="15" placeholder="<!-- Enter your HTML code here -->"
                class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition-colors duration-200 resize-none"></textarea>
            
            <button id="generate-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                Generate Link
            </button>

            <!-- Loading & Result Display -->
            <div id="status-message" class="text-center text-sm font-medium hidden"></div>

            <div id="result-container" class="hidden flex flex-col space-y-2 p-4 bg-gray-50 rounded-md border border-gray-200">
                <p class="text-sm text-gray-600">Your page is ready! Share this link:</p>
                <a id="result-link" target="_blank"
                    class="break-all text-blue-600 hover:text-blue-800 hover:underline font-semibold cursor-pointer transition-colors duration-200"></a>
            </div>

            <!-- Your Links View -->
            <div id="your-links-view" class="hidden flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-gray-800">Your Created HTML Links</h2>
                <div id="links-list" class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-md border border-gray-200">
                    <p class="text-gray-500 text-center">Loading your links...</p>
                </div>
            </div>
        </div>

        <!-- Preview View -->
        <div id="preview-view" class="hidden w-full h-full flex flex-col space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                <h1 class="text-xl font-bold text-gray-800 mb-0">Page Preview</h1>
                <div class="flex space-x-2">
                    <button id="fullscreen-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        View in Fullscreen
                    </button>
                    <button id="delete-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Delete
                    </button>
                    <button id="back-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Go Back
                    </button>
                </div>
            </div>
            <!-- Iframe for secure and functional preview -->
            <iframe id="page-content-iframe" title="Generated HTML"
                    class="w-full min-h-[500px] bg-white rounded-md border border-gray-300"></iframe>
            <!-- Shimmer loader for the iframe -->
            <div id="shimmer-loader" class="w-full min-h-[500px] rounded-md shimmer"></div>
            <p id="not-found-message" class="text-center text-gray-500 hidden mt-8">Sorry, that page was not found.</p>
            <p id="deleted-message" class="text-center text-gray-500 hidden mt-8">Sorry, the user that owns this HTML is no longer available. This HTML has been hidden.</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <p id="confirmation-text" class="text-lg text-gray-800 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, deleteDoc, query, where, getDocs, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAWhTRVqFCT_EWFzdu_AIu_-uHTiDE5_Tw",
            authDomain: "vnodetest-d5756.firebaseapp.com",
            projectId: "vnodetest-d5756",
            storageBucket: "vnodetest-d5756.firebasestorage.app",
            messagingSenderId: "29283951278",
            appId: "1:29283951278:web:7a3dd9498a8ebebdb3033f",
            measurementId: "G-3VVQQ2MP1B"
        };
        
        // UI elements
        const appContainer = document.getElementById('app-container');
        const mainView = document.getElementById('main-view');
        const previewView = document.getElementById('preview-view');
        const htmlInput = document.getElementById('html-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusMessage = document.getElementById('status-message');
        const resultContainer = document.getElementById('result-container');
        const resultLink = document.getElementById('result-link');
        const pageContentIframe = document.getElementById('page-content-iframe');
        const backBtn = document.getElementById('back-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const notFoundMessage = document.getElementById('not-found-message');
        const deletedMessage = document.getElementById('deleted-message');
        const shimmerLoader = document.getElementById('shimmer-loader');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuModal = document.getElementById('menu-modal');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const yourLinksBtn = document.getElementById('your-links-btn');
        const accountManagementBtn = document.getElementById('account-management-btn');
        const accountOptions = document.getElementById('account-options');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const yourLinksView = document.getElementById('your-links-view');
        const linksList = document.getElementById('links-list');

        let db, auth;
        let isAuthReady = false;

        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                console.log("Firebase initialized.");

                await signInAnonymously(auth);
                isAuthReady = true;
                console.log("Authentication successful.");
                
                const urlParams = new URLSearchParams(window.location.search);
                const pageIdFromQuery = urlParams.get('pageId');
                const pathParts = window.location.pathname.split('/');
                const pageIdFromPath = (pathParts.length > 2 && pathParts[1] === 'pages') ? pathParts[2] : null;

                const pageId = pageIdFromPath || pageIdFromQuery;
                
                if (pageId) {
                    showPreview(pageId);
                } else {
                    showMainView();
                }

            } catch (error) {
                console.error("Error initializing Firebase or authentication:", error);
                showMainView();
            }
        }

        function showMainView() {
            mainView.classList.remove('hidden');
            yourLinksView.classList.add('hidden');
            previewView.classList.add('hidden');
            appContainer.classList.remove('h-full', 'w-full');
            appContainer.classList.add('max-w-2xl');
            menuModal.classList.add('hidden');
            menuModal.querySelector('div').classList.remove('translate-x-0');
        }
        
        function showYourLinksView() {
            mainView.classList.remove('flex-col');
            mainView.classList.add('hidden');
            yourLinksView.classList.remove('hidden');
            htmlInput.classList.add('hidden');
            generateBtn.classList.add('hidden');
            statusMessage.classList.add('hidden');
            resultContainer.classList.add('hidden');
            menuModal.classList.add('hidden');
            menuModal.querySelector('div').classList.remove('translate-x-0');
            loadUserLinks();
        }

        async function showPreview(pageId) {
            mainView.classList.add('hidden');
            previewView.classList.remove('hidden');
            appContainer.classList.remove('max-w-2xl');
            appContainer.classList.add('h-full', 'w-full');
            shimmerLoader.classList.remove('hidden');
            pageContentIframe.classList.add('hidden');
            notFoundMessage.classList.add('hidden');
            deletedMessage.classList.add('hidden');
            deleteBtn.classList.add('hidden');
            menuModal.classList.add('hidden');
            menuModal.querySelector('div').classList.remove('translate-x-0');
            await loadPage(pageId);
        }

        async function generateLink() {
            if (!isAuthReady) {
                console.error("Auth is not ready yet.");
                return;
            }

            const htmlContent = htmlInput.value.trim();
            if (htmlContent === "") {
                statusMessage.textContent = "Please enter some HTML code.";
                statusMessage.classList.remove('hidden', 'text-blue-600', 'text-green-600');
                statusMessage.classList.add('text-red-600');
                return;
            }

            statusMessage.textContent = "Generating...";
            statusMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
            statusMessage.classList.add('text-blue-600');
            resultContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const userId = auth.currentUser.uid;
                const docRef = await addDoc(collection(db, `generatedPages`), {
                    html: htmlContent,
                    userId: userId,
                    createdAt: new Date()
                });

                const newUrl = `${window.location.origin}/pages/${docRef.id}`;
                resultLink.textContent = newUrl;
                resultLink.href = newUrl;
                
                statusMessage.textContent = "Success!";
                statusMessage.classList.remove('text-blue-600', 'text-red-600');
                statusMessage.classList.add('text-green-600');
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error generating link:", error);
                statusMessage.textContent = "An error occurred. Please try again.";
                statusMessage.classList.remove('text-blue-600', 'text-green-600');
                statusMessage.classList.add('text-red-600');
            } finally {
                generateBtn.disabled = false;
            }
        }

        async function loadPage(pageId) {
            if (!isAuthReady) {
                console.error("Auth is not ready yet.");
                return;
            }

            try {
                const docRef = doc(db, `generatedPages`, pageId);
                const docSnap = await getDoc(docRef);
                
                shimmerLoader.classList.add('hidden');
                pageContentIframe.classList.remove('hidden');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Check if the owner's account has been "deleted"
                    const userDocRef = doc(db, 'deletedUsers', data.userId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        pageContentIframe.srcdoc = '';
                        deletedMessage.classList.remove('hidden');
                        return;
                    }

                    pageContentIframe.srcdoc = data.html;
                    
                    const currentUserId = auth.currentUser.uid;
                    if (data.userId && data.userId === currentUserId) {
                        deleteBtn.classList.remove('hidden');
                        deleteBtn.dataset.docId = pageId;
                    } else {
                        deleteBtn.classList.add('hidden');
                    }
                } else {
                    pageContentIframe.srcdoc = '';
                    notFoundMessage.classList.remove('hidden');
                    console.log("Document not found for ID:", pageId);
                }
            } catch (error) {
                console.error("Error loading page:", error);
                pageContentIframe.srcdoc = '';
                notFoundMessage.classList.remove('hidden');
            }
        }
        
        async function loadUserLinks() {
            if (!isAuthReady) {
                linksList.innerHTML = '<p class="text-gray-500 text-center">Authentication not ready...</p>';
                return;
            }
            
            linksList.innerHTML = '<p class="text-gray-500 text-center">Loading your links...</p>';
            
            try {
                const userId = auth.currentUser.uid;
                const q = query(collection(db, `generatedPages`), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    linksList.innerHTML = '<p class="text-gray-500 text-center">You have not created any pages yet.</p>';
                    return;
                }
                
                let linksHtml = '';
                querySnapshot.forEach((doc) => {
                    const pageId = doc.id;
                    const pageUrl = `${window.location.origin}/pages/${pageId}`;
                    linksHtml += `<a href="${pageUrl}" target="_blank" class="block text-sm text-blue-600 hover:text-blue-800 hover:underline break-all">${pageUrl}</a>`;
                });
                linksList.innerHTML = linksHtml;
                
            } catch (error) {
                console.error("Error loading user links:", error);
                linksList.innerHTML = '<p class="text-red-500 text-center">Error loading links. Please try again.</p>';
            }
        }

        async function deletePage() {
            const docId = deleteBtn.dataset.docId;
            if (!docId) return;
            
            confirmationText.textContent = "Are you sure you want to delete this page? This action cannot be undone.";
            confirmBtn.textContent = "Delete";
            confirmationModal.classList.remove('hidden');

            const confirmHandler = async () => {
                try {
                    await deleteDoc(doc(db, `generatedPages`, docId));
                    console.log("Page deleted successfully!");
                    history.pushState({}, '', '/');
                    showMainView();
                } catch (error) {
                    console.error("Error deleting document:", error);
                } finally {
                    confirmationModal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                }
            };
            
            const cancelHandler = () => {
                confirmationModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }

        async function deleteAccount() {
            if (!isAuthReady) {
                console.error("Auth is not ready yet.");
                return;
            }
            
            const userId = auth.currentUser.uid;
            if (!userId) {
                console.error("User ID not available.");
                return;
            }

            confirmationText.textContent = "Are you sure you want to delete your account? Your pages will be hidden, but not permanently deleted. This action is irreversible.";
            confirmBtn.textContent = "Confirm";
            confirmationModal.classList.remove('hidden');

            const confirmHandler = async () => {
                try {
                    const docRef = doc(db, 'deletedUsers', userId);
                    await setDoc(docRef, { isDeleted: true });
                    console.log("Account marked as deleted.");
                    // After "deleting" the account, show the main view
                    history.pushState({}, '', '/');
                    showMainView();
                } catch (error) {
                    console.error("Error marking account for deletion:", error);
                } finally {
                    confirmationModal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                }
            };

            const cancelHandler = () => {
                confirmationModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }

        // Event Listeners
        generateBtn.addEventListener('click', generateLink);
        backBtn.addEventListener('click', () => {
            history.pushState({}, '', '/');
            showMainView();
        });
        deleteBtn.addEventListener('click', deletePage);
        fullscreenBtn.addEventListener('click', () => {
            if (pageContentIframe.requestFullscreen) {
                pageContentIframe.requestFullscreen();
            } else if (pageContentIframe.mozRequestFullScreen) { // Firefox
                pageContentIframe.mozRequestFullScreen();
            } else if (pageContentIframe.webkitRequestFullscreen) { // Chrome, Safari, Opera
                pageContentIframe.webkitRequestFullscreen();
            } else if (pageContentIframe.msRequestFullscreen) { // IE/Edge
                pageContentIframe.msRequestFullscreen();
            }
        });
        menuBtn.addEventListener('click', () => {
            menuModal.classList.remove('hidden');
            setTimeout(() => menuModal.querySelector('div').classList.add('translate-x-0'), 10);
        });
        closeMenuBtn.addEventListener('click', () => {
            menuModal.querySelector('div').classList.remove('translate-x-0');
            setTimeout(() => menuModal.classList.add('hidden'), 300);
        });
        accountManagementBtn.addEventListener('click', () => {
            accountOptions.classList.toggle('hidden');
        });
        yourLinksBtn.addEventListener('click', showYourLinksView);
        deleteAccountBtn.addEventListener('click', deleteAccount);

        // Initialize on page load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>

