<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Page Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* Shimmer effect for loading */
        .shimmer {
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 800px 104px;
            animation: shimmer 1.2s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }
            100% {
                background-position: 468px 0;
            }
        }
        
        #confirmation-modal, #menu-modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Hamburger Menu Button -->
    <button id="menu-btn" class="absolute top-4 left-4 z-50 p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-200">
        <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
    </button>

    <!-- Side Menu Modal -->
    <div id="menu-modal" class="fixed inset-0 z-40 bg-gray-900 bg-opacity-50 hidden">
        <div class="fixed top-0 left-0 h-full w-64 bg-white rounded-r-lg shadow-xl p-6 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Menu</h2>
                <button id="your-links-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200">
                    Your Created HTML Links
                </button>
                <div id="account-management-menu" class="hidden">
                    <button id="account-management-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200">
                        Account Management
                    </button>
                    <div id="account-options" class="pl-4 hidden flex flex-col space-y-2 pt-2 border-t mt-2">
                        <button id="create-profile-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">
                            Create Personal Profile
                        </button>
                        <button id="view-profile-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">
                            View My Profile
                        </button>
                        <button id="delete-account-btn" class="text-left text-red-500 hover:text-red-700 transition-colors duration-200">
                            Delete Account
                        </button>
                    </div>
                </div>
                <button id="sign-out-btn" class="text-left text-gray-700 hover:text-blue-600 transition-colors duration-200 hidden">
                    Sign Out
                </button>
            </div>
            <button id="close-menu-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="app-container" class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl transition-all duration-300">
        <!-- Main Form View -->
        <div id="main-view" class="flex flex-col space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">Generate Your HTML Page</h1>
            <p class="text-center text-gray-600">Enter your HTML code below and get a shareable link.</p>

            <button id="sign-in-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                Sign In with Google
            </button>
            
            <textarea id="html-input" rows="15" placeholder="<!-- Enter your HTML code here -->"
                class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition-colors duration-200 resize-none"></textarea>
            
            <button id="generate-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                Generate Link
            </button>

            <!-- Loading & Result Display -->
            <div id="status-message" class="text-center text-sm font-medium hidden"></div>

            <div id="result-container" class="hidden flex flex-col space-y-2 p-4 bg-gray-50 rounded-md border border-gray-200">
                <p class="text-sm text-gray-600">Your page is ready! Share this link:</p>
                <a id="result-link" target="_blank"
                    class="break-all text-blue-600 hover:text-blue-800 hover:underline font-semibold cursor-pointer transition-colors duration-200"></a>
            </div>
        </div>

        <!-- Your Links View -->
        <div id="your-links-view" class="hidden flex flex-col space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                <h2 class="text-xl font-bold text-gray-800">Your Created HTML Links</h2>
                <button id="back-from-links-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                    Go Back
                </button>
            </div>
            <div id="links-list" class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-md border border-gray-200">
                <p class="text-gray-500 text-center">Loading your links...</p>
            </div>
        </div>
        
        <!-- Create/Edit Profile View -->
        <div id="create-profile-view" class="hidden flex flex-col space-y-6">
            <h1 id="profile-form-header" class="text-3xl font-bold text-center text-gray-800">Create Personal Profile</h1>
            <p id="profile-form-subheader" class="text-center text-gray-600">Create a unique profile to share your work.</p>
            
            <label for="profile-nickname" class="text-sm font-medium text-gray-700">Nickname</label>
            <input type="text" id="profile-nickname" placeholder="Your nickname"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
            
            <label for="profile-username" class="text-sm font-medium text-gray-700">Username</label>
            <input type="text" id="profile-username" placeholder="A unique username"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
            <p id="username-status" class="text-sm font-medium text-red-500"></p>

            <label for="profile-bio" class="text-sm font-medium text-gray-700">Bio</label>
            <textarea id="profile-bio" rows="5" placeholder="Tell us about yourself!"
                class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition-colors duration-200 resize-none"></textarea>
            
            <button id="create-profile-btn-submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                Create Profile
            </button>
            <button id="back-from-create-profile-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                Go Back
            </button>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="hidden flex-col space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                <div class="flex flex-col">
                    <h1 id="profile-nickname-display" class="text-3xl font-bold text-gray-800"></h1>
                    <p id="profile-username-display" class="text-gray-500 text-sm"></p>
                </div>
                <div class="flex space-x-2">
                    <button id="edit-profile-btn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Edit
                    </button>
                    <button id="back-from-profile-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Go Back
                    </button>
                </div>
            </div>
            <p id="profile-bio-display" class="text-gray-700 leading-relaxed"></p>
            <h2 class="text-xl font-bold text-gray-800 border-t pt-4 mt-4">Created Pages</h2>
            <div id="profile-links-list" class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-md border border-gray-200">
                <p class="text-gray-500 text-center">Loading created pages...</p>
            </div>
        </div>

        <!-- Preview View -->
        <div id="preview-view" class="hidden w-full h-full flex flex-col space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                <h1 class="text-xl font-bold text-gray-800 mb-0">Page Preview</h1>
                <div class="flex space-x-2">
                    <button id="fullscreen-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        View in Fullscreen
                    </button>
                    <button id="delete-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Delete
                    </button>
                    <button id="back-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition-all duration-200 transform hover:scale-105 active:scale-95">
                        Go Back
                    </button>
                </div>
            </div>
            <!-- Iframe for secure and functional preview -->
            <iframe id="page-content-iframe" title="Generated HTML" allowfullscreen
                    class="w-full min-h-[500px] bg-white rounded-md border border-gray-300"></iframe>
            <!-- Shimmer loader for the iframe -->
            <div id="shimmer-loader" class="w-full min-h-[500px] rounded-md shimmer"></div>
            <p id="not-found-message" class="text-center text-gray-500 hidden mt-8">Sorry, that page was not found.</p>
            <p id="deleted-message" class="text-center text-gray-500 hidden mt-8">Sorry, the user that owns this HTML is no longer available. This HTML has been hidden.</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <p id="confirmation-text" class="text-lg text-gray-800 mb-4"></p>
            <div id="confirmation-buttons" class="flex justify-end space-x-2">
                <button id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, deleteDoc, query, where, getDocs, setDoc, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAWhTRVqFCT_EWFzdu_AIu_-uHTiDE5_Tw",
            authDomain: "vnodetest-d5756.firebaseapp.com",
            projectId: "vnodetest-d5756",
            storageBucket: "vnodetest-d5756.firebasestorage.app",
            messagingSenderId: "29283951278",
            appId: "1:29283951278:web:7a3dd9498a8ebebdb3033f",
            measurementId: "G-3VVQQ2MP1B"
        };
        
        // UI elements
        const appContainer = document.getElementById('app-container');
        const mainView = document.getElementById('main-view');
        const previewView = document.getElementById('preview-view');
        const yourLinksView = document.getElementById('your-links-view');
        const htmlInput = document.getElementById('html-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusMessage = document.getElementById('status-message');
        const resultContainer = document.getElementById('result-container');
        const resultLink = document.getElementById('result-link');
        const pageContentIframe = document.getElementById('page-content-iframe');
        const backBtn = document.getElementById('back-btn');
        const backFromLinksBtn = document.getElementById('back-from-links-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const notFoundMessage = document.getElementById('not-found-message');
        const deletedMessage = document.getElementById('deleted-message');
        const shimmerLoader = document.getElementById('shimmer-loader');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmationButtons = document.getElementById('confirmation-buttons');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuModal = document.getElementById('menu-modal');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const yourLinksBtn = document.getElementById('your-links-btn');
        const accountManagementBtn = document.getElementById('account-management-btn');
        const accountOptions = document.getElementById('account-options');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const linksList = document.getElementById('links-list');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const createProfileBtn = document.getElementById('create-profile-btn');
        const createProfileView = document.getElementById('create-profile-view');
        const profileNicknameInput = document.getElementById('profile-nickname');
        const profileUsernameInput = document.getElementById('profile-username');
        const profileBioInput = document.getElementById('profile-bio');
        const createProfileSubmitBtn = document.getElementById('create-profile-btn-submit');
        const usernameStatus = document.getElementById('username-status');
        const backFromCreateProfileBtn = document.getElementById('back-from-create-profile-btn');
        const profileView = document.getElementById('profile-view');
        const profileNicknameDisplay = document.getElementById('profile-nickname-display');
        const profileUsernameDisplay = document.getElementById('profile-username-display');
        const profileBioDisplay = document.getElementById('profile-bio-display');
        const profileLinksList = document.getElementById('profile-links-list');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const backFromProfileBtn = document.getElementById('back-from-profile-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const profileFormHeader = document.getElementById('profile-form-header');
        const profileFormSubheader = document.getElementById('profile-form-subheader');


        let db, auth, userId, hasProfile = false, currentUsername = null, isEditingProfile = false;

        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        signInBtn.classList.add('hidden');
                        signOutBtn.classList.remove('hidden');
                        generateBtn.classList.remove('hidden');
                        accountManagementBtn.parentElement.classList.remove('hidden');
                        deleteAccountBtn.classList.remove('hidden');
                        if (!user.isAnonymous) {
                            await checkUserProfile();
                        } else {
                            createProfileBtn.classList.add('hidden');
                            viewProfileBtn.classList.add('hidden');
                        }
                    } else {
                        userId = null;
                        signInBtn.classList.remove('hidden');
                        signOutBtn.classList.add('hidden');
                        accountManagementBtn.parentElement.classList.add('hidden');
                    }
                    handleRouting();
                });
            } catch (error) {
                console.error("Error initializing Firebase or authentication:", error);
                handleRouting();
            }
        }
        
        function handleRouting() {
            const path = window.location.pathname;
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for profile view
            if (path.startsWith('/profiles/')) {
                const username = path.split('/')[2];
                if (username) {
                    showProfileView(username);
                    return;
                }
            }

            // Check for create/edit profile view
            if (path === '/account/createprofile') {
                showCreateProfileView();
                return;
            }

            // Check for page preview view
            const pageId = urlParams.get('pageId');
            if (path.startsWith('/pages/') && path.split('/').length === 3) {
                const pageIdFromPath = path.split('/')[2];
                if (pageIdFromPath) {
                    showPreview(pageIdFromPath);
                    return;
                }
            } else if (pageId) {
                showPreview(pageId);
                return;
            }

            // Default to main view
            showMainView();
        }

        async function checkUserProfile() {
            if (!userId) {
                hasProfile = false;
                createProfileBtn.classList.add('hidden');
                viewProfileBtn.classList.add('hidden');
                return;
            }
            try {
                const docRef = doc(db, 'profiles', userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    hasProfile = true;
                    currentUsername = docSnap.data().username;
                    createProfileBtn.classList.add('hidden');
                    viewProfileBtn.classList.remove('hidden');
                } else {
                    hasProfile = false;
                    createProfileBtn.classList.remove('hidden');
                    viewProfileBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error checking user profile:", error);
                hasProfile = false;
            }
        }

        function showView(viewId) {
            const views = [mainView, yourLinksView, previewView, createProfileView, profileView];
            views.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                    view.style.display = 'flex';
                } else {
                    view.classList.add('hidden');
                    view.style.display = 'none';
                }
            });
            if (viewId === 'preview-view' || viewId === 'profile-view') {
                appContainer.classList.remove('max-w-2xl');
                appContainer.classList.add('h-full', 'w-full');
            } else {
                appContainer.classList.remove('h-full', 'w-full');
                appContainer.classList.add('max-w-2xl');
            }
            menuModal.classList.add('hidden');
            menuModal.querySelector('div').classList.remove('translate-x-0');
        }

        function showMainView() {
            showView('main-view');
        }
        
        function showYourLinksView() {
            showView('your-links-view');
            loadUserLinks();
        }

        async function showCreateProfileView() {
            if (auth.currentUser && auth.currentUser.isAnonymous) {
                history.pushState({}, '', '/');
                showMainView();
                return;
            }

            showView('create-profile-view');
            usernameStatus.textContent = '';
            
            if (hasProfile) {
                isEditingProfile = true;
                profileFormHeader.textContent = "Edit Personal Profile";
                profileFormSubheader.textContent = "Update your nickname and bio.";
                createProfileSubmitBtn.textContent = "Update Profile";
                profileUsernameInput.disabled = true;

                try {
                    const profileDoc = await getDoc(doc(db, 'profiles', userId));
                    if (profileDoc.exists()) {
                        const data = profileDoc.data();
                        profileNicknameInput.value = data.nickname;
                        profileUsernameInput.value = data.username;
                        profileBioInput.value = data.bio;
                    }
                } catch (error) {
                    console.error("Error fetching profile data for editing:", error);
                }

            } else {
                isEditingProfile = false;
                profileFormHeader.textContent = "Create Personal Profile";
                profileFormSubheader.textContent = "Create a unique profile to share your work.";
                createProfileSubmitBtn.textContent = "Create Profile";
                profileUsernameInput.disabled = false;
                profileNicknameInput.value = '';
                profileUsernameInput.value = '';
                profileBioInput.value = '';
            }
        }

        async function showProfileView(username) {
            showView('profile-view');
            
            profileNicknameDisplay.textContent = 'Loading...';
            profileUsernameDisplay.textContent = '';
            profileBioDisplay.textContent = '';
            profileLinksList.innerHTML = '<p class="text-gray-500 text-center">Loading...</p>';
            editProfileBtn.classList.add('hidden');

            try {
                const q = query(collection(db, 'profiles'), where('username', '==', username));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    window.location.href = '/404.html';
                    return;
                }

                const profileDoc = querySnapshot.docs[0];
                const profileData = profileDoc.data();
                const profileUserId = profileData.userId;

                profileNicknameDisplay.textContent = profileData.nickname;
                profileUsernameDisplay.textContent = `@${profileData.username}`;
                profileBioDisplay.textContent = profileData.bio;
                
                if (userId && profileUserId === userId) {
                    editProfileBtn.classList.remove('hidden');
                }

                const linksQuery = query(collection(db, `generatedPages`), where("userId", "==", profileUserId));
                const linksSnapshot = await getDocs(linksQuery);

                if (linksSnapshot.empty) {
                    profileLinksList.innerHTML = '<p class="text-gray-500 text-center">This user has not created any pages yet.</p>';
                } else {
                    let linksHtml = '';
                    linksSnapshot.forEach((doc) => {
                        const pageId = doc.id;
                        const pageUrl = `${window.location.origin}/pages/${pageId}`;
                        linksHtml += `<a href="${pageUrl}" class="block text-sm text-blue-600 hover:text-blue-800 hover:underline break-all">${pageUrl}</a>`;
                    });
                    profileLinksList.innerHTML = linksHtml;
                }

            } catch (error) {
                console.error("Error loading profile:", error);
                profileLinksList.innerHTML = '<p class="text-red-500 text-center">Error loading profile data.</p>';
            }
        }

        async function showPreview(pageId) {
            showView('preview-view');
            shimmerLoader.classList.remove('hidden');
            pageContentIframe.classList.add('hidden');
            notFoundMessage.classList.add('hidden');
            deletedMessage.classList.add('hidden');
            deleteBtn.classList.add('hidden');
            await loadPage(pageId);
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log("Signed in with Google successfully.");
            } catch (error) {
                console.error("Error during Google sign-in:", error);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                console.log("User signed out.");
                history.pushState({}, '', '/');
                showMainView();
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }

        async function submitProfileForm() {
            if (isEditingProfile) {
                await updateProfile();
            } else {
                await createProfile();
            }
        }

        async function createProfile() {
            const username = profileUsernameInput.value.trim().toLowerCase();
            const nickname = profileNicknameInput.value.trim();
            const bio = profileBioInput.value.trim();

            if (!username || !nickname) {
                usernameStatus.textContent = "Nickname and username are required.";
                return;
            }

            if (!/^[a-z0-9-_]+$/.test(username)) {
                usernameStatus.textContent = "Username can only contain lowercase letters, numbers, hyphens, and underscores.";
                return;
            }

            try {
                const usernameQuery = query(collection(db, 'profiles'), where('username', '==', username));
                const usernameSnapshot = await getDocs(usernameQuery);
                const unavailableQuery = query(collection(db, 'unavailableUsernames'), where('username', '==', username));
                const unavailableSnapshot = await getDocs(unavailableQuery);

                if (!usernameSnapshot.empty || !unavailableSnapshot.empty) {
                    usernameStatus.textContent = "This username is already taken.";
                    return;
                }

                await setDoc(doc(db, 'profiles', userId), {
                    nickname,
                    username,
                    bio,
                    userId,
                    createdAt: new Date()
                });

                console.log("Profile created successfully!");
                history.pushState({}, '', `/profiles/${username}`);
                showProfileView(username);

            } catch (error) {
                console.error("Error creating profile:", error);
                usernameStatus.textContent = "An error occurred. Please try again.";
            }
        }

        async function updateProfile() {
            const nickname = profileNicknameInput.value.trim();
            const bio = profileBioInput.value.trim();
            
            if (!nickname) {
                usernameStatus.textContent = "Nickname is required.";
                return;
            }

            try {
                await updateDoc(doc(db, 'profiles', userId), {
                    nickname,
                    bio
                });
                console.log("Profile updated successfully!");
                history.pushState({}, '', `/profiles/${currentUsername}`);
                showProfileView(currentUsername);
            } catch (error) {
                console.error("Error updating profile:", error);
                usernameStatus.textContent = "An error occurred. Please try again.";
            }
        }

        async function generateLink() {
            if (!userId) {
                console.log("User not authenticated, signing in anonymously...");
                await signInAnonymously(auth);
            }

            const htmlContent = htmlInput.value.trim();
            if (htmlContent === "") {
                statusMessage.textContent = "Please enter some HTML code.";
                statusMessage.classList.remove('hidden', 'text-blue-600', 'text-green-600');
                statusMessage.classList.add('text-red-600');
                return;
            }

            statusMessage.textContent = "Generating...";
            statusMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
            statusMessage.classList.add('text-blue-600');
            resultContainer.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const docRef = await addDoc(collection(db, `generatedPages`), {
                    html: htmlContent,
                    userId: userId,
                    createdAt: new Date()
                });

                const newUrl = `${window.location.origin}/pages/${docRef.id}`;
                resultLink.textContent = newUrl;
                resultLink.href = newUrl;
                
                statusMessage.textContent = "Success!";
                statusMessage.classList.remove('text-blue-600', 'text-red-600');
                statusMessage.classList.add('text-green-600');
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error generating link:", error);
                statusMessage.textContent = "An error occurred. Please try again.";
                statusMessage.classList.remove('text-blue-600', 'text-green-600');
                statusMessage.classList.add('text-red-600');
            } finally {
                generateBtn.disabled = false;
            }
        }

        async function loadPage(pageId) {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            try {
                const docRef = doc(db, `generatedPages`, pageId);
                const docSnap = await getDoc(docRef);

                shimmerLoader.classList.add('hidden');
                pageContentIframe.classList.remove('hidden');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    const userDocRef = doc(db, 'deletedUsers', data.userId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        pageContentIframe.srcdoc = '';
                        deletedMessage.classList.remove('hidden');
                        return;
                    }

                    pageContentIframe.srcdoc = data.html;
                    
                    if (userId && data.userId === userId) {
                        deleteBtn.classList.remove('hidden');
                        deleteBtn.dataset.docId = pageId;
                    } else {
                        deleteBtn.classList.add('hidden');
                    }
                } else {
                    pageContentIframe.srcdoc = '';
                    notFoundMessage.classList.remove('hidden');
                    console.log("Document not found for ID:", pageId);
                }
            } catch (error) {
                console.error("Error loading page:", error);
                pageContentIframe.srcdoc = '';
                notFoundMessage.classList.remove('hidden');
            }
        }
        
        async function loadUserLinks() {
            if (!userId) {
                linksList.innerHTML = '<p class="text-gray-500 text-center">Sign in to view your links.</p>';
                return;
            }
            
            linksList.innerHTML = '<p class="text-gray-500 text-center">Loading your links...</p>';
            
            try {
                const q = query(collection(db, `generatedPages`), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    linksList.innerHTML = '<p class="text-gray-500 text-center">You have not created any pages yet.</p>';
                    return;
                }
                
                let linksHtml = '';
                querySnapshot.forEach((doc) => {
                    const pageId = doc.id;
                    const pageUrl = `${window.location.origin}/pages/${pageId}`;
                    linksHtml += `<a href="${pageUrl}" class="block text-sm text-blue-600 hover:text-blue-800 hover:underline break-all">${pageUrl}</a>`;
                });
                linksList.innerHTML = linksHtml;
                
            } catch (error) {
                console.error("Error loading user links:", error);
                linksList.innerHTML = '<p class="text-red-500 text-center">Error loading links. Please try again.</p>';
            }
        }

        async function deletePage() {
            const docId = deleteBtn.dataset.docId;
            if (!docId) return;
            
            confirmationText.textContent = "Are you sure you want to delete this page? This action cannot be undone.";
            confirmBtn.textContent = "Delete";
            confirmationModal.classList.remove('hidden');
            confirmationButtons.classList.remove('hidden');
            
            confirmBtn.onclick = async () => {
                try {
                    await deleteDoc(doc(db, `generatedPages`, docId));
                    console.log("Page deleted successfully!");
                    history.pushState({}, '', '/');
                    showMainView();
                } catch (error) {
                    console.error("Error deleting document:", error);
                } finally {
                    confirmationModal.classList.add('hidden');
                }
            };
            
            cancelBtn.onclick = () => {
                confirmationModal.classList.add('hidden');
            };
        }

        async function deleteAccount() {
            if (!userId) {
                console.error("User ID not available.");
                return;
            }
            
            confirmationText.textContent = "Are you sure you want to delete your account? Your profile will be permanently deleted, and your pages will be hidden. Your username cannot be reused.";
            confirmBtn.textContent = "Confirm";
            confirmationModal.classList.remove('hidden');
            confirmationButtons.classList.remove('hidden');

            const confirmHandler = async () => {
                try {
                    const profileRef = doc(db, 'profiles', userId);
                    const profileSnap = await getDoc(profileRef);
                    const profileData = profileSnap.data();

                    if (profileData && profileData.username) {
                        await setDoc(doc(db, 'unavailableUsernames', profileData.username), {
                            deletedAt: new Date()
                        });
                        await deleteDoc(profileRef);
                    }
                    
                    await setDoc(doc(db, 'deletedUsers', userId), { isDeleted: true });
                    await signOut(auth);
                    
                    confirmationText.textContent = "Your account has been deleted.";
                    confirmationButtons.innerHTML = `
                        <button id="refresh-page-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">Refresh Page</button>
                    `;
                    document.getElementById('refresh-page-btn').onclick = () => {
                        location.reload();
                    };
                } catch (error) {
                    console.error("Error deleting account:", error);
                    confirmationModal.classList.add('hidden');
                }
            };

            const cancelHandler = () => {
                confirmationModal.classList.add('hidden');
            };

            confirmBtn.onclick = confirmHandler;
            cancelBtn.onclick = cancelHandler;
        }

        // Event Listeners
        generateBtn.addEventListener('click', generateLink);
        backBtn.addEventListener('click', () => {
            history.pushState({}, '', '/');
            showMainView();
        });
        backFromLinksBtn.addEventListener('click', () => {
            history.pushState({}, '', '/');
            showMainView();
        });
        deleteBtn.addEventListener('click', deletePage);
        fullscreenBtn.addEventListener('click', () => {
            if (pageContentIframe.requestFullscreen) {
                pageContentIframe.requestFullscreen();
            } else if (pageContentIframe.mozRequestFullScreen) { // Firefox
                pageContentIframe.mozRequestFullScreen();
            } else if (pageContentIframe.webkitRequestFullscreen) { // Chrome, Safari, Opera
                pageContentIframe.webkitRequestFullscreen();
            } else if (pageContentIframe.msRequestFullscreen) { // IE/Edge
                pageContentIframe.msRequestFullscreen();
            }
        });
        menuBtn.addEventListener('click', () => {
            accountOptions.classList.toggle('hidden');
        });
        closeMenuBtn.addEventListener('click', () => {
            menuModal.querySelector('div').classList.remove('translate-x-0');
            setTimeout(() => menuModal.classList.add('hidden'), 300);
        });
        accountManagementBtn.addEventListener('click', () => {
            accountOptions.classList.toggle('hidden');
        });
        yourLinksBtn.addEventListener('click', showYourLinksView);
        deleteAccountBtn.addEventListener('click', deleteAccount);
        signInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);
        createProfileBtn.addEventListener('click', () => {
            history.pushState({}, '', '/account/createprofile');
            showCreateProfileView();
        });
        backFromCreateProfileBtn.addEventListener('click', () => {
            history.pushState({}, '', '/');
            showMainView();
        });
        createProfileSubmitBtn.addEventListener('click', submitProfileForm);
        viewProfileBtn.addEventListener('click', () => {
            history.pushState({}, '', `/profiles/${currentUsername}`);
            showProfileView(currentUsername);
        });
        backFromProfileBtn.addEventListener('click', () => {
            history.pushState({}, '', '/');
            showMainView();
        });
        editProfileBtn.addEventListener('click', () => {
            history.pushState({}, '', `/account/createprofile`);
            showCreateProfileView();
        });
        
        menuBtn.addEventListener('click', () => {
            menuModal.classList.remove('hidden');
            setTimeout(() => menuModal.querySelector('div').classList.add('translate-x-0'), 10);
        });
        
        // Initialize on page load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>

